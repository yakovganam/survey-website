#!/bin/bash
# Automated Render.com & MongoDB Atlas Deployment Script
# For Israeli 2026 Elections Survey

set -e

echo "üöÄ Israeli 2026 Elections Survey - Automated Deployment Script"
echo "=============================================================="
echo ""

# Configuration
GITHUB_USER="yakovganam"
REPO_NAME="israeli-2026-elections-survey"
GITHUB_REPO_URL="https://github.com/${GITHUB_USER}/${REPO_NAME}"
RENDER_APP_NAME="israeli-2026-elections"

echo "üìã Pre-flight checks..."
echo "  ‚úÖ GitHub Repository: $GITHUB_REPO_URL"
echo "  ‚úÖ Code branch: master"
echo ""

echo "‚ö†Ô∏è  MANUAL STEPS REQUIRED:"
echo ""
echo "1Ô∏è‚É£  SET UP MONGODB ATLAS"
echo "   Step 1.1: Go to https://www.mongodb.com/cloud/atlas"
echo "   Step 1.2: Sign up / Log in"
echo "   Step 1.3: Create new project ‚Üí 'Israeli Elections Survey'"
echo "   Step 1.4: Create free cluster (M0):"
echo "            - Name: cluster0"
echo "            - Region: Select your region"
echo "   Step 1.5: Go to 'Database Access' ‚Üí 'Add Database User'"
echo "            - Username: survey_user"
echo "            - Password: [Generate and save securely]"
echo "            - Role: Atlas Admin"
echo "   Step 1.6: Go to 'Network Access' ‚Üí 'Add IP Address'"
echo "            - IP: 0.0.0.0/0 (allow everywhere)"
echo "            - Click confirm"
echo "   Step 1.7: Click 'Clusters' ‚Üí 'Connect' ‚Üí 'Connect your app'"
echo "            - Driver: Node.js 4.0 or later"
echo "            - Copy connection string"
echo "            - Replace <password> with your password"
echo ""
echo "   üíæ SAVE THIS CONNECTION STRING:"
echo "   mongodb+srv://survey_user:YOUR_PASSWORD@cluster0.mongodb.net/surveydb?retryWrites=true&w=majority"
echo ""

echo "2Ô∏è‚É£  CREATE RENDER WEB SERVICE"
echo "   Step 2.1: Go to https://render.com"
echo "   Step 2.2: Sign up / Log in (GitHub recommended)"
echo "   Step 2.3: Click 'New +' ‚Üí 'Web Service'"
echo "   Step 2.4: Select repository:"
echo "            - Repo: $GITHUB_REPO_URL"
echo "            - Branch: master"
echo "   Step 2.5: Configure service:"
echo "            - Name: $RENDER_APP_NAME"
echo "            - Environment: Node"
echo "            - Build Command: npm install"
echo "            - Start Command: npm start"
echo "            - Plan: Free"
echo ""

echo "3Ô∏è‚É£  SET ENVIRONMENT VARIABLES ON RENDER"
echo "   In Render Dashboard ‚Üí Your Service ‚Üí Environment:"
echo ""
echo "   Add these variables:"
echo "   NODE_ENV=production"
echo "   PORT=3000"
echo "   MONGODB_URI=mongodb+srv://survey_user:YOUR_PASSWORD@cluster0.mongodb.net/surveydb?retryWrites=true&w=majority"
echo ""

echo "4Ô∏è‚É£  DEPLOY"
echo "   - Click 'Create Web Service' button"
echo "   - Wait for build to complete (~3-5 minutes)"
echo "   - Get your live URL: https://$RENDER_APP_NAME.onrender.com"
echo ""

echo "5Ô∏è‚É£  VERIFY DEPLOYMENT"
echo "   Test these URLs:"
echo "   - Health check: https://$RENDER_APP_NAME.onrender.com/api/health"
echo "   - Survey page: https://$RENDER_APP_NAME.onrender.com/"
echo "   - Test voting functionality"
echo ""

echo "‚úÖ DEPLOYMENT CHECKLIST"
echo "   [ ] MongoDB Atlas cluster created"
echo "   [ ] Database user created (survey_user)"
echo "   [ ] Network access configured"
echo "   [ ] Connection string copied"
echo "   [ ] Render.com account created"
echo "   [ ] GitHub repo connected to Render"
echo "   [ ] Environment variables set"
echo "   [ ] Web service deployed"
echo "   [ ] Homepage loads successfully"
echo "   [ ] Can vote for a party"
echo "   [ ] Results display correctly"
echo "   [ ] 24-hour vote cooldown works"
echo ""

echo "üîó FINAL LINKS"
echo "   GitHub: $GITHUB_REPO_URL"
echo "   Live URL: https://$RENDER_APP_NAME.onrender.com"
echo "   Render Dashboard: https://dashboard.render.com"
echo "   MongoDB Atlas: https://cloud.mongodb.com"
echo ""

echo "üìû TROUBLESHOOTING"
echo "   Issue: Build fails"
echo "   ‚Üí Check Render logs for npm install errors"
echo ""
echo "   Issue: MongoDB connection error"
echo "   ‚Üí Verify MONGODB_URI env variable is correct"
echo "   ‚Üí Check MongoDB cluster is running"
echo "   ‚Üí Confirm network access allows 0.0.0.0/0"
echo ""
echo "   Issue: Voting not working"
echo "   ‚Üí Check /api/health endpoint returns connected"
echo "   ‚Üí Verify MONGODB_URI in Render environment"
echo ""

echo "=============================================================="
echo "Created: 2026-01-30"
echo "Ready for production deployment ‚úÖ"
